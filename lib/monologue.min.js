/**
 * monologue.js - EventEmitter replacement with AMQP-style bindings and other advanced features. Compatible with postal.js's API.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.2.1
 * Url: https://github.com/postaljs/monologue.js
 * License(s): MIT, GPL
 */
(function(t,n){"object"==typeof module&&module.exports?module.exports=n(require("lodash"),require("riveter")):"function"==typeof define&&define.amd?define(["lodash","riveter"],function(e,i){return n(e,i,t)}):t.Monologue=n(t._,t.riveter,t)})(this,function(t,n,e,i){function c(t,n){return function(){if(console.warn||console.log){var e="Warning, the "+t+" method has been deprecated. Please use "+n+" instead.";console.warn?console.warn(e):console.log(e)}return a.prototype[n].apply(this,arguments)}}function r(t,n,e){return function(i){v.resolver.compare(i.topic,t)&&(n.push(i),i.cacheKeys.push(t),e&&e(i))}}function s(t,n,e){return function(i,c,r){i===t&&r.splice(c,1),0===r.length&&delete e[n]}}function o(n,e){if(n.unsubscribe(),n.cacheKeys&&n.cacheKeys.length)for(var i;i=n.cacheKeys.pop();)t.each(e.cache[i],s(n,i,e.cache))}var u={cache:{},regex:{},compare:function(n,e){var i,c,r,s=this.cache[e+"-"+n];return s===!0?s:-1===n.indexOf("#")&&-1===n.indexOf("*")?s=this.cache[e+"-"+n]=e===n:((c=this.regex[n])||(i="^"+t.map(n.split("."),function(t){var n="";return r&&(n="#"!==r?"\\.\\b":"\\b"),n+="#"===t?"[\\s\\S]*":"*"===t?"[^.]+":t,r=t,n}).join("")+"$",c=this.regex[n]=new RegExp(i)),s=this.cache[e+"-"+n]=c.test(e))},reset:function(){this.cache={},this.regex={}}},a=function(t,n,e){this.topic=t,this.callback=n,this.pipeline=[],this.cacheKeys=[],this._context=i,this.emitter=e},h=function(){var n;return function(e){var i=!1;return t.isString(e)?(i=e===n,n=e):(i=t.isEqual(e,n),n=t.clone(e)),!i}},f=function(){var n=[];return function(e){var i=!t.any(n,function(n){return t.isObject(e)||t.isArray(e)?t.isEqual(e,n):e===n});return i&&n.push(e),i}};a.prototype={"catch":function(t){var n=this.callback,e=function(){try{n.apply(this,arguments)}catch(e){t(e,arguments[0])}};return this.callback=e,this},defer:function(){return this.delay(0)},disposeAfter:function(n){if(!t.isNumber(n)||0>=n)throw new Error("The value provided to disposeAfter (maxCalls) must be a number greater than zero.");var e=this,i=t.after(n,t.bind(function(){e.unsubscribe()}));return e.pipeline.push(function(t,n,e){e(t,n),i()}),e},distinct:function(){return this.constraint(new f)},distinctUntilChanged:function(){return this.constraint(new h)},invokeSubscriber:function(t,n){if(!this.inactive){var e=this,i=e.pipeline,c=i.length,r=e._context,s=-1;if(c){i=i.concat([e.callback]);var o=function u(t,n){s+=1,c>s?i[s].call(r,t,n,u):e.callback.call(r,t,n)};o(t,n,0)}else e.callback.call(r,t,n)}},logError:function(){if(console){var t;t=console.warn?console.warn:console.log,this["catch"](t)}return this},once:function(){return this.disposeAfter(1)},subscribe:function(t){return this.callback=t,this},unsubscribe:function(){this.inactive||(this.inactive=!0,this.emitter._subscriptions[this.topic]=t.without(this.emitter._subscriptions[this.topic],this))},constraint:function(n){if(!t.isFunction(n))throw new Error("Predicate constraint must be a function");return this.pipeline.push(function(t,e,i){n.call(this,t,e)&&i(t,e)}),this},constraints:function(n){var e=this;return t.isArray(n)&&t.each(n,function(t){e.constraint(t)}),e},context:function(t){return this._context=t,this},debounce:function(n,e){if(!t.isNumber(n))throw new Error("Milliseconds must be a number");return this.pipeline.push(t.debounce(function(t,n,e){e(t,n)},n,!!e)),this},delay:function(n){if(!t.isNumber(n))throw new Error("Milliseconds must be a number");var e=this;return e.pipeline.push(function(t,e,i){setTimeout(function(){i(t,e)},n)}),this},throttle:function(n){if(!t.isNumber(n))throw new Error("Milliseconds must be a number");var e=function(t,n,e){e(t,n)};return this.pipeline.push(t.throttle(e,n)),this}},a.prototype.off=a.prototype.unsubscribe;for(var p=["withConstraint","withConstraints","withContext","withDebounce","withDelay","withThrottle"],l=["constraint","constraints","context","debounce","delay","throttle"],b=0;6>b;b++){var d=p[b];a.prototype[d]=c(d,l[b])}var v=function(){};return v.prototype={on:function(n,e){var i=this;return i._subscriptions=i._subscriptions||{},i._subscriptions[n]=i._subscriptions[n]||[],i._subscriptions[n].push(new a(n,e,i)),t.each(this.cache,function(t,e){e===n&&r(n,t)(subDef)}),i._subscriptions[n][i._subscriptions[n].length-1]},once:function(t,n){return this.on(t,n).once()},off:function(n,e){var i=this;switch(i._subscriptions=i._subscriptions||{},i._cache=i._cache||{},arguments.length){case 0:t.each(i._subscriptions,function(n){t.each(n,function(t){o(t)})}),i._subscriptions={};break;case 1:var c="[object String]"===Object.prototype.toString.call(n)?"topic":n instanceof a?"def":"context";switch(c){case"topic":if(i._subscriptions[n])for(;i._subscriptions[n].length;)o(i._subscriptions[n].pop());break;case"context":t.each(i._subscriptions,function(e){t.each(t.clone(e),function(t,i){t._context===n&&(o(t),e.splice(i,1))})});break;default:o(n)}break;default:t.each(t.clone(i._subscriptions[n]),function(t,c){t._context===e&&(o(t),i._subscriptions[n].splice(c,1))})}},emit:function(n,e){var i=this.getEnvelope(n,e);this._cache=this._cache||{};var c=this._cache[n],s=function(t){t.invokeSubscriber(i.data,i)};if(c)t.each(c,s);else{c=this._cache[n]=[];var o=r(n,c,s);t.each(this._subscriptions,function(n){t.each(n,o)})}},getEnvelope:function(t,n){return{topic:t,timeStamp:new Date,data:n}}},v.resolver=u,v.debug=!1,v.SubscriptionDefinition=a,n(v),v.mixInto=function(t){n.punch(t,v.prototype)},v});