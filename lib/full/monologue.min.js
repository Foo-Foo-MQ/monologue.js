/*
 monologue.js
 Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT (http://www.opensource.org/licenses/mit-license) & GPL (http://www.opensource.org/licenses/gpl-license)
 Version 0.1.4
 */
(function(e,t){typeof module=="object"&&module.exports?module.exports=function(e,n){return t(e,n)}:typeof define=="function"&&define.amd?define(["underscore","riveter"],function(n,r){return t(n,e)}):e.Monologue=t(e._,e.riveter,e)})(this,function(e,t,n,r){var i={cache:{},compare:function(e,t){if(this.cache[t]&&this.cache[t][e])return!0;var n=("^"+e.replace(/\./g,"\\.").replace(/\*/g,"[A-Z,a-z,0-9]*").replace(/#/g,".*")+"$").replace("\\..*$","(\\..*)*$").replace("^.*\\.","^(.*\\.)*"),r=new RegExp(n),i=r.test(t);return i&&(this.cache[t]=this.cache[t]||{},this.cache[t][e]=!0),i},reset:function(){this.cache={}}},s=function(){var t;return function(n){var r=!1;return e.isString(n)?(r=n===t,t=n):(r=e.isEqual(n,t),t=e.clone(n)),!r}},o=function(){var t=[];return function(n){var r=!e.any(t,function(t){return e.isObject(n)||e.isArray(n)?e.isEqual(n,t):n===t});return r&&t.push(n),r}},u=function(e,t,n){this.topic=e,this.callback=t,this.context=null,this.constraints=[],this.emitter=n};e.extend(u.prototype,{withContext:function(e){return this.context=e,this},unsubscribe:function(){this.emitter._subscriptions[this.topic]=e.without(this.emitter._subscriptions[this.topic],this)},disposeAfter:function(t){if(e.isNaN(t)||t<=0)throw"The value provided to disposeAfter (maxCalls) must be a number greater than zero.";var n=this,r=e.after(t,function(){n.unsubscribe()}),i=n.callback;return n.callback=function(){i.apply(n.context,arguments),r()},n},once:function(){return this.disposeAfter(1)},defer:function(){var e=this.callback;return this.callback=function(t){setTimeout(e,0,t)},this},distinctUntilChanged:function(){return this.withConstraint(new s),this},distinct:function(){return this.withConstraint(new o),this},withConstraint:function(t){if(!e.isFunction(t))throw"Predicate constraint must be a function";return this.constraints.push(t),this},withConstraints:function(t){var n=this;return e.isArray(t)&&e.each(t,function(e){n.withConstraint(e)}),n},withDebounce:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";var n=this.callback;return this.callback=e.debounce(n,t),this},withDelay:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";var n=this.callback;return this.callback=function(e){setTimeout(function(){n(e)},t)},this},withThrottle:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";var n=this.callback;return this.callback=e.throttle(n,t),this}}),u.prototype.off=u.prototype.unsubscribe,e.extend(u.prototype,{defer:function(){var e=this.callback;return this.callback=function(t){setTimeout(e,0,t)},this},distinctUntilChanged:function(){return this.withConstraint(new s),this},distinct:function(){return this.withConstraint(new o),this},withConstraint:function(t){if(!e.isFunction(t))throw"Predicate constraint must be a function";return this.constraints.push(t),this},withConstraints:function(t){var n=this;return e.isArray(t)&&e.each(t,function(e){n.withConstraint(e)}),n},withDebounce:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";var n=this.callback;return this.callback=e.debounce(n,t),this},withDelay:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";var n=this.callback;return this.callback=function(e){setTimeout(function(){n(e)},t)},this},withThrottle:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";var n=this.callback;return this.callback=e.throttle(n,t),this}});var a=function(t,n){if(f.resolver.compare(t.topic,n.topic)&&e.all(t.constraints,function(e){return e(n.data,n)})&&typeof t.callback=="function")try{t.callback.apply(t.context,[n.data,n])}catch(r){f.debug&&typeof console!="undefined"&&typeof console.log=="function"&&(console.log("Monologue Emit Exception Caught"),console.log(r)),t.failed=!0,this._trackErrors&&(this._yuno||(this._yuno=[]),this._yuno.push({def:t,env:n,exception:r}))}},f=function(){};return f.prototype={on:function(e,t){var n=this;return n._subscriptions=n._subscriptions||{},n._subscriptions[e]=n._subscriptions[e]||[],n._subscriptions[e].push(new u(e,t,n)),n._subscriptions[e][n._subscriptions[e].length-1]},once:function(e,t){return this.on(e,t).once()},off:function(t,n){this._subscriptions=this._subscriptions||{};switch(arguments.length){case 0:e.each(this._subscriptions,function(t){e.each(t,function(e){e.unsubscribe()})}),this._subscriptions={};break;case 1:var r=Object.prototype.toString.call(t)==="[object String]"?"topic":t instanceof u?"def":"context";switch(r){case"topic":if(this._subscriptions[t])while(this._subscriptions[t].length)this._subscriptions[t].pop().unsubscribe();break;case"context":e.each(this._subscriptions,function(n){e.each(e.clone(n),function(e,r){e.context===t&&(e.unsubscribe(),n.splice(r,1))})});break;default:t.unsubscribe()}break;default:e.each(e.clone(this._subscriptions[t]),function(e,r){e.context===n&&(e.unsubscribe(),this._subscriptions[t].splice(r,1))},this)}},emit:function(t,n){var r=this.getEnvelope(t,n);this._subscriptions=this._subscriptions||{},e.each(this._subscriptions,function(e){var t=0,n=e.length,i;while(t<n)(i=e[t++])&&a.call(this,i,r)},this)},getEnvelope:function(e,t){return{topic:e,timeStamp:new Date,data:t}}},f.resolver=i,f.debug=!1,f.SubscriptionDefinition=u,t(f),f})